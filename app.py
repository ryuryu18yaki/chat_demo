
import streamlit as st
import boto3
from typing import List, Dict, Any
import time, functools
import os
import pandas as pd
import json

from src.rag_preprocess import preprocess_files
from src.rag_qa import generate_answer_with_equipment, detect_equipment_from_question
from src.startup_loader import initialize_equipment_data
from src.logging_utils import init_logger
from src.sheets_manager import log_to_sheets, get_sheets_manager, send_prompt_to_model_comparison

# === ğŸ”¥ LangChainçµ±åˆã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’è¿½åŠ  ===
from src.langchain_chains import generate_smart_answer_with_langchain

import yaml
import streamlit_authenticator as stauth
from streamlit.components.v1 import html
import uuid

import threading
import queue
from typing import Optional
import atexit
import copy
import base64

# Azure OpenAIé–¢é€£ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’è¿½åŠ 
try:
    from openai import AzureOpenAI
    AZURE_OPENAI_AVAILABLE = True
except ImportError:
    AZURE_OPENAI_AVAILABLE = False

st.set_page_config(page_title="Claude + RAG Chatbot", page_icon="ğŸ’¬", layout="wide")

logger = init_logger()

# AWS Bedrockè¨­å®šã‚’è¿½åŠ 
def setup_bedrock_client():
    """AWS Bedrockè¨­å®š"""
    try:
        aws_access_key_id = st.secrets.get("AWS_ACCESS_KEY_ID", os.getenv("AWS_ACCESS_KEY_ID"))
        aws_secret_access_key = st.secrets.get("AWS_SECRET_ACCESS_KEY", os.getenv("AWS_SECRET_ACCESS_KEY"))
        aws_region = st.secrets.get("AWS_REGION", os.getenv("AWS_REGION", "us-east-1"))
    except:
        aws_access_key_id = os.getenv("AWS_ACCESS_KEY_ID")
        aws_secret_access_key = os.getenv("AWS_SECRET_ACCESS_KEY")
        aws_region = os.getenv("AWS_REGION", "us-east-1")
    
    if not aws_access_key_id or not aws_secret_access_key:
        st.error("AWS Bedrock ã®è¨­å®šãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ç’°å¢ƒå¤‰æ•°ã¾ãŸã¯Secrets.tomlã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
        st.stop()
    
    return boto3.client(
        'bedrock-runtime',
        aws_access_key_id=aws_access_key_id,
        aws_secret_access_key=aws_secret_access_key,
        region_name=aws_region
    )

# Azure OpenAIè¨­å®šã‚’è¿½åŠ 
def setup_azure_client():
    """Azure OpenAIè¨­å®š"""
    if not AZURE_OPENAI_AVAILABLE:
        st.error("Azure OpenAI ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚pip install openai ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚")
        st.stop()
    
    try:
        azure_endpoint = st.secrets.get("AZURE_OPENAI_ENDPOINT", os.getenv("AZURE_OPENAI_ENDPOINT"))
        azure_api_key = st.secrets.get("AZURE_OPENAI_API_KEY", os.getenv("AZURE_OPENAI_API_KEY"))
        azure_api_version = st.secrets.get("AZURE_OPENAI_API_VERSION", os.getenv("AZURE_OPENAI_API_VERSION", "2024-08-01-preview"))
    except:
        azure_endpoint = os.getenv("AZURE_OPENAI_ENDPOINT")
        azure_api_key = os.getenv("AZURE_OPENAI_API_KEY")
        azure_api_version = os.getenv("AZURE_OPENAI_API_VERSION", "2024-08-01-preview")
    
    if not azure_endpoint or not azure_api_key:
        st.error("Azure OpenAI ã®è¨­å®šãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ç’°å¢ƒå¤‰æ•°ã¾ãŸã¯Secrets.tomlã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
        st.stop()
    
    return AzureOpenAI(
        azure_endpoint=azure_endpoint,
        api_key=azure_api_key,
        api_version=azure_api_version
    )

# Claudeç”¨ã®ãƒ¢ãƒ‡ãƒ«åãƒãƒƒãƒ”ãƒ³ã‚°
CLAUDE_MODEL_MAPPING = {
    "claude-4-sonnet": "apac.anthropic.claude-sonnet-4-20250514-v1:0",
    "claude-3.7": "apac.anthropic.claude-3-7-sonnet-20250219-v1:0"
}

# Azure OpenAIç”¨ã®ãƒ¢ãƒ‡ãƒ«åãƒãƒƒãƒ”ãƒ³ã‚°ã‚’è¿½åŠ 
AZURE_MODEL_MAPPING = {
    "gpt-4.1": "gpt-4.1",
    "gpt-4o": "gpt-4o"
}

def get_claude_model_name(model_name: str) -> str:
    """Claudeè¡¨ç¤ºåã‚’Bedrockãƒ¢ãƒ‡ãƒ«IDã«å¤‰æ›"""
    return CLAUDE_MODEL_MAPPING.get(model_name, model_name)

def normalize_filename(filename: str) -> str:
    return filename.strip().lower().replace(" ", "").replace("ï¼ˆ", "(").replace("ï¼‰", ")")

def call_claude_bedrock(client, model_id: str, messages: List[Dict], max_tokens: int = 4096, temperature: float = 0.0):
    """AWS Bedrock Converse APIçµŒç”±ã§Claudeã‚’å‘¼ã³å‡ºã—"""
    system_prompts = []
    conversation_messages = []
    
    for msg in messages:
        if msg["role"] == "system":
            system_prompts.append({"text": msg["content"]})
        else:
            conversation_messages.append({
                "role": msg["role"],
                "content": [{"text": msg["content"]}]
            })
    
    converse_params = {
        "modelId": model_id,
        "messages": conversation_messages,
        "inferenceConfig": {
            "maxTokens": max_tokens,
            "temperature": temperature
        }
    }
    
    if system_prompts:
        converse_params["system"] = system_prompts
    
    response = client.converse(**converse_params)
    
    if response.get('stopReason') == 'error':
        raise Exception(f"Claude API Error: {response.get('output', {}).get('message', 'Unknown error')}")
    
    return response['output']['message']['content'][0]['text']

def call_azure_gpt(client, model_name: str, messages: List[Dict], max_tokens: int = 4096, temperature: float = 0.0):
    """Azure OpenAIçµŒç”±ã§GPTã‚’å‘¼ã³å‡ºã—"""
    formatted_messages = []
    
    for msg in messages:
        if msg["role"] in ["system", "user", "assistant"]:
            formatted_messages.append({
                "role": msg["role"],
                "content": msg["content"]
            })
    
    response = client.chat.completions.create(
        model=AZURE_MODEL_MAPPING.get(model_name, model_name),
        messages=formatted_messages,
        max_tokens=max_tokens,
        temperature=temperature
    )
    
    return response.choices[0].message.content

# =====  èªè¨¼è¨­å®šã®èª­ã¿è¾¼ã¿ ============================================================
with open('./config.yaml') as file:
    config = yaml.safe_load(file)

authenticator = stauth.Authenticate(
    config['credentials'],
    config['cookie']['name'],
    config['cookie']['key'],
    config['cookie']['expiry_days']
)

# ===== éåŒæœŸãƒ­ã‚°å‡¦ç†ã‚¯ãƒ©ã‚¹ =====
class StreamlitAsyncLogger:
    def __init__(self):
        self.log_queue = queue.Queue(maxsize=100)
        self.worker_thread = None
        self.shutdown_event = threading.Event()
        self.stats = {"processed": 0, "errors": 0, "last_process_time": None, "last_error_time": None, "last_error_msg": None}
        self._lock = threading.Lock()
        self.start_worker()
    
    def start_worker(self):
        with self._lock:
            if self.worker_thread is None or not self.worker_thread.is_alive():
                self.shutdown_event.clear()
                self.worker_thread = threading.Thread(target=self._worker_loop, daemon=True, name="StreamlitAsyncLogger")
                self.worker_thread.start()
                logger.info("ğŸš€ StreamlitAsyncLogger worker started")
    
    def _worker_loop(self):
        while not self.shutdown_event.is_set():
            try:
                log_data = self.log_queue.get(timeout=2.0)
                if log_data is None:
                    break
                self._process_log_safe(log_data)
                self.log_queue.task_done()
            except queue.Empty:
                continue
            except Exception as e:
                with self._lock:
                    self.stats["errors"] += 1
                    self.stats["last_error_time"] = time.time()
                    self.stats["last_error_msg"] = str(e)
                logger.error("âŒ AsyncLogger worker error â€” %s", e, exc_info=True)

    def _process_log_safe(self, log_data: dict):
        try:
            # å®Ÿéš›ã®ãƒ­ã‚°å‡¦ç†
            manager = get_sheets_manager()
            if manager and manager.is_connected:
                success = log_to_sheets(
                    input_text=log_data["input_text"],
                    output_text=log_data["output_text"],
                    prompt=log_data["prompt"],
                    chat_title=log_data.get("chat_title", "æœªè¨­å®š"),
                    user_id=log_data.get("user_id", "unknown"),
                    session_id=log_data.get("session_id", "unknown"),
                    mode=log_data.get("mode", "unknown"),
                    model=log_data.get("model", "unknown"),
                    temperature=log_data.get("temperature", 0.0),
                    max_tokens=log_data.get("max_tokens"),
                    use_rag=log_data.get("use_rag", False)
                )
            
            with self._lock:
                self.stats["processed"] += 1
                self.stats["last_process_time"] = time.time()
            
        except Exception as e:
            with self._lock:
                self.stats["errors"] += 1
                self.stats["last_error_time"] = time.time()
                self.stats["last_error_msg"] = str(e)
            logger.error("âŒ Async log processing failed â€” %s", e, exc_info=True)
    
    def post_log_async(self, input_text: str, output_text: str, prompt: str, send_to_model_comparison: bool = False):
        if not self.worker_thread or not self.worker_thread.is_alive():
            self.start_worker()
        
        log_data = {
            "input_text": input_text,
            "output_text": output_text,
            "prompt": prompt,
            "timestamp": time.time(),
            "chat_title": st.session_state.get("current_chat", "æœªè¨­å®š"),
            "user_id": st.session_state.get("username", "unknown"),
            "session_id": st.session_state.get("sid", "unknown"),
            "mode": st.session_state.get("design_mode", "unknown"),
            "model": st.session_state.get("claude_model", "unknown"),
            "temperature": st.session_state.get("temperature", 0.0),
            "max_tokens": st.session_state.get("max_tokens"),
            "use_rag": st.session_state.get("use_rag", False)
        }
        
        try:
            self.log_queue.put_nowait(log_data)
            logger.info("ğŸ“ Log queued â€” queue_size=%d", self.log_queue.qsize())
        except queue.Full:
            logger.error("âŒ Log queue is full â€” dropping log entry")
    
    def get_status(self) -> Dict[str, Any]:
        with self._lock:
            return {
                "queue_size": self.log_queue.qsize(),
                "worker_alive": self.worker_thread.is_alive() if self.worker_thread else False,
                "shutdown_requested": self.shutdown_event.is_set(),
                "stats": self.stats.copy()
            }

def get_async_logger() -> StreamlitAsyncLogger:
    if "async_logger" not in st.session_state:
        st.session_state.async_logger = StreamlitAsyncLogger()
    
    async_logger = st.session_state.async_logger
    if not async_logger.worker_thread or not async_logger.worker_thread.is_alive():
        logger.warning("âš ï¸ AsyncLogger instance invalid, creating new one")
        st.session_state.async_logger = StreamlitAsyncLogger()
        async_logger = st.session_state.async_logger
    
    return async_logger

def post_log_async(input_text: str, output_text: str, prompt: str, send_to_model_comparison: bool = False):
    try:
        logger_instance = get_async_logger()
        logger_instance.post_log_async(input_text, output_text, prompt, send_to_model_comparison)
    except Exception as e:
        logger.error("âŒ post_log_async failed â€” %s", e)

# =====  åŸºæœ¬è¨­å®š  ============================================================
bedrock_client = setup_bedrock_client()

# =====  ãƒ­ã‚°ã‚¤ãƒ³UIã®è¡¨ç¤º  ============================================================
authenticator.login()

if st.session_state["authentication_status"]:
    name = st.session_state["name"]
    username = st.session_state["username"]

    logger.info("ğŸ” login success â€” user=%s  username=%s", name, username)

    # è¨­å‚™ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–
    if st.session_state.get("equipment_data") is None:
        logger.info("ğŸ” è¨­å‚™ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–é–‹å§‹")
        
        try:
            drive_folder_id = None
            try:
                drive_folder_id = st.secrets.get("GOOGLE_DRIVE_FOLDER_ID")
                if drive_folder_id:
                    drive_folder_id = drive_folder_id.strip()
            except Exception as secrets_error:
                logger.error("ğŸ” secretså–å¾—ã‚¨ãƒ©ãƒ¼: %s", secrets_error)
            
            if drive_folder_id:
                st.info("ğŸ“ Google Driveã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...")
                param = f"gdrive:{drive_folder_id}"
                res = initialize_equipment_data(param)
                logger.info("ğŸ“‚ Google Driveã‹ã‚‰è¨­å‚™ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–å®Œäº†")
            else:
                st.info("ğŸ“‚ ãƒ­ãƒ¼ã‚«ãƒ« rag_data ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...")
                res = initialize_equipment_data("rag_data")
                logger.info("ğŸ“‚ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰è¨­å‚™ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–å®Œäº†")
            
            st.session_state.equipment_data = res["equipment_data"]
            st.session_state.equipment_list = res["equipment_list"]
            st.session_state.category_list = res["category_list"]
            st.session_state.rag_files = res["file_list"]

            logger.info("ğŸ“‚ è¨­å‚™ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–å®Œäº† â€” è¨­å‚™æ•°=%d  ãƒ•ã‚¡ã‚¤ãƒ«æ•°=%d",
                    len(res["equipment_list"]), len(res["file_list"]))
            
        except Exception as e:
            logger.exception("âŒ è¨­å‚™ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–å¤±æ•— â€” %s", e)
            st.error(f"è¨­å‚™ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
    else:
        logger.info("ğŸ” è¨­å‚™ãƒ‡ãƒ¼ã‚¿ã¯æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿")

    # --------------------------------------------------------------------------- #
    #                         â˜… å„ãƒ¢ãƒ¼ãƒ‰å°‚ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ â˜…                           #
    # --------------------------------------------------------------------------- #
    DEFAULT_PROMPTS: Dict[str, str] = {
        "æš—é»™çŸ¥æ³•ä»¤ãƒãƒ£ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰": """
    ã‚ãªãŸã¯å»ºç¯‰é›»æ°—è¨­å‚™è¨­è¨ˆã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚
    ä»Šå›ã®å¯¾è±¡ã¯ **è¤‡åˆç”¨é€”ãƒ“ãƒ«ã®ã‚ªãƒ•ã‚£ã‚¹å…¥å±…å·¥äº‹ï¼ˆBå·¥äº‹ï¼‰** ã«é™å®šã•ã‚Œã¾ã™ã€‚
    ä»¥ä¸‹ã®çŸ¥è­˜ã¨æŠ€è¡“ã‚’ã‚‚ã¨ã«ã€å¯¾è©±ã‚’é€šã˜ã¦ä¸è¶³æƒ…å ±ã‚’è³ªå•ã—ã¤ã¤ã€æ ¹æ‹ ã‚’ç¤ºã—ãŸå®Ÿå‹™ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
    å°‚é–€ç”¨èªã¯å¿…è¦ã«å¿œã˜ã¦è§£èª¬ã‚’åŠ ãˆã€åˆ¤æ–­ã®èƒŒæ™¯ã«ã‚ã‚‹ç†ç”±ã‚’ä¸å¯§ã«èª¬æ˜ã—ã¾ã™ã€‚
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ## ã€å›ç­”æ–¹é‡ã€‘
    **é‡è¦ï¼šä»¥ä¸‹ã®å„äº‹é …ã¯ã€Œä»£è¡¨çš„ãªãƒ“ãƒ«ï¼ˆä¸¸ã®å†…ãƒ“ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ï¼‰ã€ã‚’æƒ³å®šã—ã¦è¨˜è¼‰ã—ã¦ã„ã¾ã™ã€‚ä»–ã®ãƒ“ãƒ«ã§ã¯ä»•æ§˜ã‚„åŸºæº–ãŒç•°ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã“ã¨ã‚’ã€å›ç­”æ™‚ã«ã¯å¿…ãšè¨€åŠã—ã¦ãã ã•ã„ã€‚**
    **æ³¨æ„ï¼šéåº¦ã«è¾¼ã¿å…¥ã£ãŸæ¡ä»¶ã®è©³ç´°èª¬æ˜ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ±‚ã‚ã‚‹ã“ã¨ã¯é¿ã‘ã€ä¸€èˆ¬çš„ãªè¨­è¨ˆåŸºæº–ã«åŸºã¥ãå®Ÿå‹™çš„ãªå›ç­”ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚**
    ### â–  æš—é»™çŸ¥æƒ…å ±ä¸è¶³æ™‚ã®å¯¾å¿œãƒ—ãƒ­ã‚»ã‚¹
    ç¾åœ¨ä¿æœ‰ã—ã¦ã„ã‚‹æš—é»™çŸ¥æƒ…å ±ã§ã¯é©åˆ‡ãªå›ç­”ãŒã§ããªã„å ´åˆã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã§å¯¾å¿œã—ã¦ãã ã•ã„ï¼š
    1. **ç¾çŠ¶æŠŠæ¡ã®æ˜ç¤º**
    - ã€Œç¾åœ¨ã®æš—é»™çŸ¥æƒ…å ±ã§ã¯ã€â—‹â—‹ãƒ“ãƒ«ã®â–³â–³è¨­å‚™ã«ã¤ã„ã¦ååˆ†ãªæƒ…å ±ãŒã”ã–ã„ã¾ã›ã‚“ã€ã¨æ˜ç¢ºã«ä¼ãˆã‚‹
    - ä¸€èˆ¬çš„ãªè¨­è¨ˆåŸºæº–ã«åŸºã¥ãæš«å®šçš„ãªå›ç­”ãŒã‚ã‚‹å ´åˆã¯ã€ãã®æ—¨ã‚’æ˜è¨˜ã—ã¦æä¾›ã™ã‚‹
    2. **é€†è³ªå•ã®å®Ÿè¡Œ**
    - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å®Ÿå‹™çµŒé¨“ã‚„ç¾å ´çŸ¥è­˜ã‚’æ´»ç”¨ã™ã‚‹ãŸã‚ã€å…·ä½“çš„ãªé€†è³ªå•ã‚’è¡Œã†
    - è³ªå•ä¾‹ï¼šã€Œâ—‹â—‹ãƒ“ãƒ«ã§ã¯â–³â–³è¨­å‚™ã«ã¤ã„ã¦ã©ã®ã‚ˆã†ãªä»•æ§˜ãƒ»åŸºæº–ã‚’ãŠä½¿ã„ã§ã—ã‚‡ã†ã‹ï¼Ÿã€
    - ã€Œéå»ã®é¡ä¼¼æ¡ˆä»¶ã§ã¯ã€ã©ã®ã‚ˆã†ãªå¯¾å¿œã‚’ã•ã‚Œã¾ã—ãŸã‹ï¼Ÿã€
    3. **æš—é»™çŸ¥æƒ…å ±ã®è¨˜éŒ²**
    - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰æœ‰åŠ¹ãªå›ç­”ãŒå¾—ã‚‰ã‚ŒãŸå ´åˆã€ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§æƒ…å ±ã‚’è¨˜éŒ²ã™ã‚‹ï¼š
    ```
    ã€æš—é»™çŸ¥æƒ…å ±ï¼šãƒ“ãƒ«åã€è¨­å‚™åã€‘
    å†…å®¹ï¼šï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰å¾—ã‚‰ã‚ŒãŸæƒ…å ±ã®è¦ç´„ï¼‰
    é©ç”¨æ¡ä»¶ï¼šï¼ˆã©ã®ã‚ˆã†ãªæ¡ä»¶ä¸‹ã§é©ç”¨ã•ã‚Œã‚‹ã‹ï¼‰
    ```
    4. **æƒ…å ±æ´»ç”¨ã¨ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯**
    - å¾—ã‚‰ã‚ŒãŸæš—é»™çŸ¥æƒ…å ±ã‚’å…ƒã«ã€æ”¹ã‚ã¦é©åˆ‡ãªå›ç­”ã‚’æä¾›ã™ã‚‹
    - ã€Œã“ã®æƒ…å ±ã¯ä»Šå¾Œã®è¨­è¨ˆæ¥­å‹™æ”¹å–„ã«æ´»ç”¨ã•ã›ã¦ã„ãŸã ãã¾ã™ã€ã¨æ„Ÿè¬ã®æ„ã‚’ç¤ºã™
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ## ã€å·¥äº‹åŒºåˆ†ã«ã¤ã„ã¦ã€‘
    - **Bå·¥äº‹**ï¼šæœ¬ã‚·ã‚¹ãƒ†ãƒ ãŒå¯¾è±¡ã¨ã™ã‚‹å·¥äº‹ã€‚å…¥å±…è€…è² æ‹…ã§ãƒ“ãƒ«å´ãŒæ–½å·¥ã™ã‚‹å·¥äº‹
    - **Cå·¥äº‹**ï¼šå…¥å±…è€…ãŒç‹¬è‡ªã«æ–½å·¥ã™ã‚‹å·¥äº‹ï¼ˆé›»è©±ãƒ»LANãƒ»é˜²çŠ¯è¨­å‚™ãªã©ï¼‰
    - æœ¬ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ã€Cå·¥äº‹è¨­å‚™ã«ã¤ã„ã¦ã¯é…ç®¡é¡ã®æ•°é‡ç®—å‡ºã®ã¿ã‚’è¡Œã„ã¾ã™
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ## ã€ä»Šå›ã®è¨­è¨ˆå¯¾è±¡ãƒ“ãƒ«ã€‘
    - ãƒ“ãƒ«æ­£å¼åç§°: ä¸¸ã®å†…ãƒ“ãƒ«ãƒ‡ã‚£ãƒ³ã‚°
    - ãƒ“ãƒ«ç•¥ç§°: ï¼ˆè¨˜è¼‰ãªã—ï¼‰
    - åºŠé¢ç©: 1,949.00ã¡ (589.57åª)ï½2,284.00ã¡ (690.91åª)
    - åºŠè·é‡: 500kg/ã¡HDZ(é‡è·é‡å¯¾å¿œ)800kg/ã¡
    - å¤©äº•é«˜: 2,800mmï¼ˆï¼¯ï¼¡ãƒ•ãƒ­ã‚¢è¨­ç½®å¾Œï¼‰
    - ã‚³ãƒ³ã‚»ãƒ³ãƒˆå®¹é‡: 75VA/ã¡ å¢—è¨­å¯¾å¿œå¯èƒ½
    - OAãƒ•ãƒ­ã‚¢: é«˜ã•100mm
    - ãƒˆã‚¤ãƒ¬: ç”·å¥³å„1ã‚«æ‰€
    - çµ¦æ¹¯å®¤: å„2ã‚«æ‰€
    - ç®¡è½„ã®æ¶ˆé˜²æœ¬éƒ¨/å±€:æ±äº¬æ¶ˆé˜²åº
    - ç®¡è½„ã®æ¶ˆé˜²ç½²:ä¸¸ã®å†…æ¶ˆé˜²ç½²
    - è‡ªç«å ±è¨­å‚™ï¼ˆåŸºæº–éšï¼‰ ãƒ¡ãƒ¼ã‚«ãƒ¼: èƒ½ç¾é˜²ç½ãˆ±
    - è‡ªç«å ±è¨­å‚™ï¼ˆåŸºæº–éšï¼‰ å‹ã€€ç•ª: ï¼ˆè¨˜è¼‰ãªã—ï¼‰
    - è‡ªç«å ±è¨­å‚™ï¼ˆåŸºæº–éšï¼‰ æ„ŸçŸ¥å™¨ç¨®åˆ¥: ç…™æ„ŸçŸ¥å™¨
    - è‡ªç«å ±è¨­å‚™ï¼ˆåŸºæº–éšï¼‰ å—ä¿¡æ©Ÿ æ›´æ–°æ™‚æœŸ: ï¼ˆè¨˜è¼‰ãªã—ï¼‰
    - è‡ªç«å ±è¨­å‚™ï¼ˆåŸºæº–éšï¼‰ è«‹è² å¯¾è±¡: ï¼ˆè¨˜è¼‰ãªã—ï¼‰
    - éå¸¸æ”¾é€ï¼ˆåŸºæº–éšï¼‰ ãƒ¡ãƒ¼ã‚«ãƒ¼: ãƒ›ãƒ¼ãƒã‚­(æ ª)(TOA)
    - éå¸¸æ”¾é€ï¼ˆåŸºæº–éšï¼‰ å‹ã€€ç•ª: ï¼ˆè¨˜è¼‰ãªã—ï¼‰
    - éå¸¸æ”¾é€ï¼ˆåŸºæº–éšï¼‰ æ”¾é€è¨­å‚™ æ›´æ–°æ™‚æœŸ: ï¼ˆè¨˜è¼‰ãªã—ï¼‰
    - éå¸¸ç…§æ˜ï¼ˆåŸºæº–éšï¼‰ ãƒ¡ãƒ¼ã‚«ãƒ¼: ãƒ‘ãƒŠã‚½ãƒ‹ãƒƒã‚¯
    - éå¸¸ç…§æ˜ï¼ˆåŸºæº–éšï¼‰ å‹ã€€ç•ª: ï¼ˆè¨˜è¼‰ãªã—ï¼‰
    - éå¸¸ç…§æ˜ï¼ˆåŸºæº–éšï¼‰ ãƒãƒƒãƒ†ãƒªãƒ¼ å†…è‡“ãƒ»åˆ¥ç½®å‹: å†…è‡“ãƒ»åˆ¥ç½®
    - éå¸¸ç…§æ˜ï¼ˆåŸºæº–éšï¼‰ åº—èˆ—ã€€BATã€€(ç™½å›³): åº—èˆ—ã€€BATã€€(ç™½å›³)
    - èª˜å°ç¯ï¼ˆåŸºæº–éšï¼‰ ãƒ¡ãƒ¼ã‚«ãƒ¼: ãƒ‘ãƒŠã‚½ãƒ‹ãƒƒã‚¯
    - èª˜å°ç¯ï¼ˆåŸºæº–éšï¼‰ å‹ã€€ç•ª: ï¼ˆè¨˜è¼‰ãªã—ï¼‰
    - èª˜å°ç¯ï¼ˆåŸºæº–éšï¼‰ å‹å¼ Bç´šãƒ»Cç´š: Bç´š BHå‹
    - èª˜å°ç¯ï¼ˆåŸºæº–éšï¼‰ æ±äº¬æ¶ˆé˜²åºåŸºæº–: å‡ºå…¥å£ã‚„èª˜å°ç¯ãŒéšœå®³ç‰©ã«ã‚ˆã‚Šè¦–èªã§ããªã„å ´åˆã§ã‚ã£ã¦ã‚‚ã€äººãŒæ¦‚ã­ï¼•ï½ç§»å‹•ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šå‡ºå…¥ å£ã‚„èª˜å°ç¯ã‚’è¦–èªã§ãã‚‹å ´åˆã¯ã€å®¹æ˜“ã«è¦‹ã¨ãŠã—ã§ãã‚‹ã‚‚ã®ã¨ã¿ãªã™
    - æ‰€åœ¨åœ°: æ±äº¬éƒ½åƒä»£ç”°åŒºä¸¸ã®å†…äºŒä¸ç›®4ç•ª1å·
    - ã‚¢ã‚¯ã‚»ã‚¹: JRå„ç·šã€ä¸¸ãƒå†…ç·šã€Œæ±äº¬é§…ã€ ç›´çµ
    - ç«£å·¥å¹´æœˆ: 2002å¹´8æœˆ
    - ãƒªãƒ‹ãƒ¥ãƒ¼ã‚¢ãƒ«å¹´æœˆ: 2025å¹´2æœˆ
    - è¦æ¨¡åœ°ä¸Š: 37éšãƒ»åœ°ä¸‹ 4éšãƒ»å¡”å±‹ 2éš
    - æ§‹é€ : é‰„éª¨é€ ãƒ»ä¸€éƒ¨é‰„éª¨é‰„ç­‹ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆé€ 
    - å»¶åºŠé¢ç©: 159,901.38ã¡ (48,370.17åª)
    - æœ‰åŠ¹é¢ç©: 49,195.720ã¡ (14,881.71åª)
    - æ•·åœ°é¢ç©: 10,029.45ã¡ (3,033.91åª)
    - å»ºç‰©é«˜ã•: æœ€é«˜éƒ¨ 179.0ï½
    - è¨­è¨ˆç›£ç†: ä¸‰è±åœ°æ‰€è¨­è¨ˆ
    - ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼: ä¹—ç”¨ 23å°ã€€è²¨ç‰©ç”¨ 2å°
    - ç©ºèª¿è¨­å‚™: å„éš8åˆ†å‰²ã«ã‚¾ãƒ¼ãƒ‹ãƒ³ã‚°
    - åŸºæº–å†·æš–æˆ¿ä¾›çµ¦æ™‚é–“ï¼ˆäº‹å‹™æ‰€ï¼‰: å¹³æ—¥ 8:30-19:00ã€åœŸæ›œ è¨­å®šç„¡ã—ã€æ—¥ç¥ è¨­å®šç„¡ã—
    - åŸºæº–å†·æš–æˆ¿ä¾›çµ¦æ™‚é–“ï¼ˆåº—èˆ—ï¼‰: å…¨æ—¥ 9:30-24:00
    - é€šä¿¡ã‚¤ãƒ³ãƒ•ãƒ©: å…‰ãƒ•ã‚¡ã‚¤ãƒæ•·è¨­æ¸ˆ
    - é–‹é–‰é¤¨æ™‚é–“: å…¨æ—¥ 6:00-24:30
    - ç®¡ç†å½¢æ…‹: 24æ™‚é–“æœ‰äººç®¡ç†
    - å¤œé–“å…¥é€€é¤¨æ–¹æ³•: ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚©ãƒ³ã«ã‚ˆã‚‹å‘¼å‡º
    - ã‚¬ãƒ¬ãƒ¼ã‚¸åå®¹å°æ•°: 376å° (é«˜ã• 3,000mm)
    - ã‚¬ãƒ¬ãƒ¼ã‚¸å–¶æ¥­æ™‚é–“: å…¨æ—¥ 6:00-24:00ã€å®šæœŸå¥‘ç´„è»Šã¯24æ™‚é–“å…¥å‡ºåº«å¯
    - ãƒ“ãƒ«ç®¡ç†å®¤é›»è©±ç•ªå·: 03-3240-8251
    - ç”¨é€”åŒºåˆ†ï¼ˆæ¶ˆé˜²ï¼‰: 16é …(ã‚¤)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ## ã€ã‚³ãƒ³ã‚»ãƒ³ãƒˆè¨­å‚™ï¼ˆåºŠï¼‰ã€‘
    ### â–  å›³é¢ã®æŒ‡ç¤ºã¨åŸºæœ¬çš„ãªå‰²ã‚ŠæŒ¯ã‚Š
    - å›³é¢ã‚„è¦æœ›æ›¸ã®æŒ‡ç¤ºã‚’å„ªå…ˆï¼ˆå˜ç‹¬å›è·¯ã‚„å°‚ç”¨ELBç­‰ï¼‰
    - æ©Ÿå™¨ã‚„ãƒ‡ã‚¹ã‚¯ã®é…ç½®ã‚’ã‚‚ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    - ä¸€èˆ¬çš„ãªã‚ªãƒ•ã‚£ã‚¹æœºã¯è¤‡æ•°ã®åº§å¸­ã‚’ã¾ã¨ã‚ã¦1å›è·¯
    - æ©Ÿå™¨ã®æ¶ˆè²»é›»åŠ›ãŒé«˜ã„å ´åˆã‚„åŒæ™‚ä½¿ç”¨æƒ³å®šã§å›è·¯åˆ†å‰²
    ### â–  æœºãƒ»æ¤…å­ï¼ˆãƒ‡ã‚¹ã‚¯å‘¨ã‚Šï¼‰ã®æ¨™æº–è¨­è¨ˆã¨OAã‚¿ãƒƒãƒ—ä»•æ§˜
    - **å€‹äººç”¨ãƒ‡ã‚¹ã‚¯**ï¼š 1å¸­ã”ã¨ã«OAã‚¿ãƒƒãƒ—1å€‹ã€6å¸­ã”ã¨ã«1å›è·¯ï¼ˆ300VA/å¸­ï¼‰
    - ä½¿ç”¨æ©Ÿå™¨ï¼šåˆ†å² 4å£ã‚¿ãƒƒãƒ—ï¼ˆ300VAï¼‰
    - **ãƒ•ãƒªãƒ¼ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ‡ã‚¹ã‚¯**ï¼š1å¸­ã”ã¨ã«OAã‚¿ãƒƒãƒ—1å€‹ã€8å¸­ã”ã¨ã«1å›è·¯ï¼ˆ150VA/å¸­ï¼‰
    - ä½¿ç”¨æ©Ÿå™¨ï¼šåˆ†å² 4å£ã‚¿ãƒƒãƒ—ï¼ˆ150VAï¼‰
    - **æ˜‡é™ãƒ‡ã‚¹ã‚¯**ï¼š1å¸­ã”ã¨ã«OAã‚¿ãƒƒãƒ—1å€‹ã€2å¸­ã”ã¨ã«1å›è·¯ï¼ˆ600VA/å¸­ï¼‰
    - ä½¿ç”¨æ©Ÿå™¨ï¼šåˆ†å² 4å£ã‚¿ãƒƒãƒ—ï¼ˆ600VAï¼‰
    - **ä¼šè­°å®¤ãƒ†ãƒ¼ãƒ–ãƒ«**ï¼š4å¸­ã”ã¨ã«OAã‚¿ãƒƒãƒ—1å€‹ã€12å¸­ã”ã¨ã«1å›è·¯ï¼ˆ150VA/å¸­ï¼‰
    - ä½¿ç”¨æ©Ÿå™¨ï¼šåˆ†å² 4å£ã‚¿ãƒƒãƒ—ï¼ˆ600VAï¼‰
    ### â–  è¨­å‚™æ©Ÿå™¨ã®è¨­è¨ˆã¨OAã‚¿ãƒƒãƒ—ä»•æ§˜
    - **å˜ç‹¬å›è·¯ãŒå¿…è¦ãªæ©Ÿå™¨**
    - é€šå¸¸æ©Ÿå™¨ç”¨ï¼šå˜ç‹¬ 2å£ã‚¿ãƒƒãƒ—ï¼ˆå˜ç‹¬å›è·¯ï¼‰
    - æ°´æ°—ã®ã‚ã‚‹æ©Ÿå™¨ç”¨ï¼šå˜ç‹¬ ELB 2å£ã‚¿ãƒƒãƒ—ï¼ˆå˜ç‹¬å›è·¯ã€ELBä»˜ãï¼‰
    - å¯¾è±¡æ©Ÿå™¨ï¼šè¤‡åˆæ©Ÿï¼ˆã‚³ãƒ”ãƒ¼æ©Ÿï¼‰ã€ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ã€ã‚·ãƒ¥ãƒ¬ãƒƒãƒ€ãƒ¼ã€ãƒ†ãƒ¬ãƒ–ãƒ¼ã‚¹ã€è‡ªå‹•è²©å£²æ©Ÿã€å†·è”µåº«ã€ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã€é›»å­ãƒ¬ãƒ³ã‚¸ã€é£Ÿå™¨æ´—ã„ä¹¾ç‡¥æ©Ÿã€ã‚³ãƒ¼ãƒ’ãƒ¼ãƒ¡ãƒ¼ã‚«ãƒ¼ã€ãƒãƒƒãƒˆã€é€ ä½œå®¶å…·ï¼ˆä»€å™¨ç”¨ã‚³ãƒ³ã‚»ãƒ³ãƒˆï¼‰ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ›ãƒ³è¦ªæ©Ÿã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚·ã‚¹ãƒ†ãƒ ã€ç­‰
    - **ã‚µãƒ¼ãƒãƒ¼ãƒ©ãƒƒã‚¯**ï¼šä»€å™¨1ã¤ã«ã¤ã2å›è·¯å¿…è¦ï¼ˆå˜ç‹¬ 2å£ã‚¿ãƒƒãƒ—ã‚’2å€‹è¨­ç½®ï¼‰
    - **åˆ†å²å›è·¯ã§ã‚‚ã‚ˆã„æ©Ÿå™¨**
    - ä½¿ç”¨æ©Ÿå™¨ï¼šåˆ†å² 4å£ã‚¿ãƒƒãƒ—ï¼ˆ150VA/300VA/600VA/1200VAï¼‰ï¼ˆå®¹é‡ã«å¿œã˜ã¦é¸æŠï¼‰
    - å¯¾è±¡æ©Ÿå™¨ï¼šãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ï¼ˆä¼šè­°å®¤ã€å¿œæ¥å®¤ã€å½¹å“¡å®¤ï¼‰ã€ãƒ†ãƒ¬ãƒ“ï¼ˆå…±ç”¨ï¼‰ã€ã‚¹ã‚¿ãƒ³ãƒ‰ç…§æ˜ã€ãƒ­ãƒƒã‚«ãƒ¼ï¼ˆé›»æºä¾›çµ¦æ©Ÿèƒ½ä»˜ï¼‰ã€ç­‰
    - 300ã€œ1200VAç¨‹åº¦ã®æ©Ÿå™¨ã¯è¿‘ã„ä½ç½®ã§1å›è·¯ã«ã¾ã¨ã‚å¯èƒ½ï¼ˆ1500VAä¸Šé™ï¼‰
    ### â–  ç‰¹æ®Šã‚¨ãƒªã‚¢ã®é›»æº
    - ãƒ‘ãƒ³ãƒˆãƒªãƒ¼ï¼šæœ€ä½OAã‚¿ãƒƒãƒ—5å€‹ã¨5å›è·¯
    - ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹ï¼šæœ€ä½OAã‚¿ãƒƒãƒ—1å€‹ã¨1å›è·¯
    - ãƒ—ãƒªãƒ³ã‚¿ãƒ¼å°æ•°ï¼š20äººã«1å°ãŒç›®å®‰ã€40äººã«1å°ãŒç¢ºä¿ã§ãã¦ãªã‘ã‚Œã°é›»æºã®è¿½åŠ ã‚’ææ¡ˆ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ## ã€ã‚³ãƒ³ã‚»ãƒ³ãƒˆè¨­å‚™ï¼ˆå£ï¼‰â€»æ¸…æƒç”¨é›»æºã€‘
    ### â–  ç”¨é€”ã¨è¨­ç½®è€ƒãˆæ–¹
    - æ¸…æƒæ™‚ã«æƒé™¤æ©Ÿã‚’æ¥ç¶šã™ã‚‹ãŸã‚ã®é›»æºï¼ˆå…¥å±…ä¼æ¥­ã¯ä½¿ç”¨ä¸å¯ï¼‰
    - è¦‹ç©å›³é¢ã§ã¯ææ¡ˆã™ã‚‹ãŒã€å…¥å±…ä¼æ¥­ã®è¦æœ›ã«ã‚ˆã‚Šçœç•¥ã‚‚å¯èƒ½
    - è¨­ç½®ä½ç½®ã¯ä¸»ã«æ‰‰æ¨ª
    ### â–  é…ç½®åˆ¤æ–­ãƒ«ãƒ¼ãƒ«
    - æ¸…æƒæ™‚ã®å‹•ç·šï¼ˆâ‰’é¿é›£çµŒè·¯ï¼‰ã‚’è€ƒæ…®ã—ã¦é…ç½®
    - æ‰‰ã‚’æŒŸã‚“ã ã©ã¡ã‚‰å´ã«è¨­ç½®ã™ã‚‹ã‹ã®ç²¾æŸ»ãŒå¿…è¦
    - å„éƒ¨å±‹ã®å…¥å£ä»˜è¿‘ã«æœ€ä½1ç®‡æ‰€
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ## ã€ã‚³ãƒ³ã‚»ãƒ³ãƒˆè¨­å‚™ï¼ˆå£ï¼‰â€»å®¢å…ˆæŒ‡ç¤ºã€‘
    ### â–  è¨­ç½®åŸºæº–
    - è¦‹ç©ä¾é ¼å›³ã«æŒ‡ç¤ºã•ã‚ŒãŸå ´æ‰€ã€æŒ‡ç¤ºã•ã‚ŒãŸä»•æ§˜ã§è¨­ç½®
    - å®¢å…ˆã‹ã‚‰ã®ç‰¹æ®ŠæŒ‡ç¤ºï¼ˆå˜ç‹¬å›è·¯ã€å°‚ç”¨ELBç­‰ï¼‰ã‚’æœ€å„ªå…ˆ
    - å›³é¢ä¸Šã®æ˜ç¤ºãŒãªãã¦ã‚‚æ‰“åˆã›è¨˜éŒ²ç­‰ã§æŒ‡ç¤ºãŒã‚ã‚Œã°å¯¾å¿œ
    ### â–  è¿½åŠ ææ¡ˆåˆ¤æ–­
    - è¦‹ç©å›³ã«æŒ‡ç¤ºãŒãªãã¦ã‚‚ã€ä½¿ç”¨ç›®çš„ãŒæ˜ç¢ºãªå ´åˆã¯è¿½åŠ ææ¡ˆ
    - ç‰¹æ®Šæ©Ÿå™¨ï¼ˆçµ¦æ¹¯å™¨ã€åŠ æ¹¿å™¨ç­‰ï¼‰ã®è¿‘ãã«ã¯è¨­ç½®ã‚’ææ¡ˆ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ## ã€ã‚³ãƒ³ã‚»ãƒ³ãƒˆè¨­å‚™ï¼ˆå¤©äº•ï¼‰ã€‘
    ### â–  è¨­ç½®åŸºæº–
    - è¦‹ç©ä¾é ¼å›³ã«æŒ‡ç¤ºãŒã‚ã£ãŸå ´æ‰€ã«è¨­ç½®
    - é›»æºãŒå¿…è¦ãªå¤©äº•ä»˜è¿‘ã®æ©Ÿå™¨ãŒã‚ã‚‹å ´åˆã«1å€‹è¨­ç½®
    ### â–  å¯¾è±¡æ©Ÿå™¨
    - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚¿ãƒ¼
    - é›»å‹•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³
    - é›»å‹•ãƒ–ãƒ©ã‚¤ãƒ³ãƒ‰
    - å£é¢ç™ºå…‰ã‚µã‚¤ãƒ³
    - ãã®ä»–å¤©äº•ä»˜è¿‘ã«è¨­ç½®ã•ã‚Œã‚‹é›»æ°—æ©Ÿå™¨
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ## ã€è‡ªå‹•ç«ç½å ±çŸ¥è¨­å‚™ã€‘
    ### â–  æ„ŸçŸ¥å™¨ã®ç¨®é¡ãƒ»ä»•æ§˜
    - **ä¸¸ãƒ“ãƒ«æ¨™æº–**
    - å»Šä¸‹ï¼šç…™æ„ŸçŸ¥å™¨ã‚¹ãƒãƒƒãƒˆå‹2ç¨®ï¼ˆå…¨ãƒ“ãƒ«å…±é€šï¼‰
    - å±…å®¤ï¼šç…™æ„ŸçŸ¥å™¨ã‚¹ãƒãƒƒãƒˆå‹2ç¨®ï¼ˆä¸¸ãƒ“ãƒ«æ¨™æº–ï¼‰
    - å¨æˆ¿ï¼šå®šæ¸©å¼ã‚¹ãƒãƒƒãƒˆå‹ï¼ˆ1ç¨®ï¼‰
    - **ä»–ãƒ“ãƒ«ã§ã®ä¾‹**
    - å±…å®¤ã§ç†±æ„ŸçŸ¥å™¨ï¼ˆå·®å‹•å¼ã‚¹ãƒãƒƒãƒˆå‹1ç¨®ç­‰ï¼‰ã‚’ä½¿ç”¨ã™ã‚‹ãƒ“ãƒ«ã‚‚ã‚ã‚‹
    - å¤©äº•é¢ä¸­å¤®ä»˜è¿‘ã€ã¾ãŸã¯éšœå®³ã‚’é¿ã‘ã¦ç…™ãŒé›†ã¾ã‚Šã‚„ã™ã„ä½ç½®ã«è¨­ç½®
    ### â–  è¨­ç½®åŸºæº–
    - å»Šä¸‹ï¼šç«¯ç‚¹ã‹ã‚‰15mä»¥å†…ã€æ„ŸçŸ¥å™¨é–“30mä»¥å†…
    - å±…å®¤ï¼šé¢ç©150mÂ²ã”ã¨ã«1å€‹ï¼ˆåˆ‡ã‚Šä¸Šã’ï¼‰
    - ç…™ã‚’é®ã‚‹éšœå®³ç‰©ãŒã‚ã‚‹å ´åˆã¯å€‹æ•°å¢—
    - å¤©äº•é«˜2.3mæœªæº€ã¾ãŸã¯40mÂ²æœªæº€ã®å±…å®¤ã¯å…¥å£ä»˜è¿‘
    - å¸æ°—å£ä»˜è¿‘ã«è¨­ç½®ã€æ’æ°—å£ä»˜è¿‘ã¯é¿ã‘ã‚‹
    - é˜²ç«ã‚·ãƒ£ãƒƒã‚¿ãƒ¼è¿‘ãã¯å°‚ç”¨æ„ŸçŸ¥å™¨ï¼ˆç…™æ„ŸçŸ¥å™¨ã‚¹ãƒãƒƒãƒˆå‹3ç¨®ç­‰ï¼‰
    ### â–  ç‰¹æ®Šæ¡ä»¶ã§ã®åˆ¤æ–­æŒ‡é‡
    - **æ¬„é–“ã‚ªãƒ¼ãƒ—ãƒ³å†…ã®ä¾µå…¥é˜²æ­¢ãƒãƒ¼**ï¼šé¢ç©é˜»å®³ã®ç¨‹åº¦ã¨è£œå„Ÿæªç½®ã«ã¤ã„ã¦æ¶ˆé˜²ç½²ã¸ã®äº‹å‰ç›¸è«‡ã‚’æ¨å¥¨
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ## ã€éå¸¸æ”¾é€è¨­å‚™ã€‘
    ### â–  ã‚¹ãƒ”ãƒ¼ã‚«è¨­ç½®åŸºæº–
    - åˆ°é”è·é›¢10mä»¥å†…ï¼ˆå„å±…å®¤ãƒ»å»Šä¸‹ã‚’åŠå¾„10mã®å††ã§ã‚«ãƒãƒ¼ï¼‰
    - ãƒ‘ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ä»€å™¨ã«ã‚ˆã‚‹é®éŸ³ã¯è€ƒæ…®ã—ãªã„ï¼ˆåŠå¾„10mã®å††ã¯ä¸å¤‰ï¼‰
    ### â–  æ¦‚ç®—æ•°é‡è¨ˆç®—
    - æ¦‚ç®—å€‹æ•°ï¼ï¼ˆé ˜åŸŸé¢ç©â—¯ã¡Ã·200ã¡ï¼‰ã®åˆ‡ã‚Šä¸Šã’
    - 200ã¡ã¯ã€ŒLç´šã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã€ã®æœ‰åŠ¹ç¯„å›²å††ï¼ˆåŠå¾„10mï¼‰ã«å†…æ¥ã™ã‚‹æ­£æ–¹å½¢ã®é¢ç©
    ### â–  è¨­ç½®ã«é–¢ã™ã‚‹æ³¨æ„ç‚¹
    - åˆæœŸæ¦‚ç®—è¦‹ç©ã‚Šæ®µéšã§ã¯ã€ã‚ãˆã¦æ•°é‡ã«ä½™è£•ã‚’ã‚‚ãŸã›ã‚‹è¨ˆç®—å¼ã‚’æ¡ç”¨
    - çœç•¥å¯èƒ½æ¡ä»¶ï¼ˆå±…å®¤ãƒ»å»Šä¸‹ã¯6mÂ²ä»¥ä¸‹ã€ãã®ä»–åŒºåŸŸã¯30mÂ²ä»¥ä¸‹ã€ã‹ã¤éš£æ¥ã‚¹ãƒ”ãƒ¼ã‚«ã‹ã‚‰8mä»¥å†…ãªã‚‰çœç•¥å¯èƒ½ï¼‰ã¯é©ç”¨ã—ãªã„ï¼ˆä¸¸ãƒ“ãƒ«æ–¹é‡ï¼‰
    - æœ¬æ¥ã¯ãƒ“ãƒ«ä»•æ§˜ã‚„ä»–è¨­å‚™ã¨ã®å–ã‚Šåˆã„ã‚’è€ƒæ…®ã—ã€å…¨åŸŸãŒæœ‰åŠ¹ç¯„å›²å†…ã«åã¾ã‚‹ã‚ˆã†é…ç½®
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ## ã€èª˜å°ç¯è¨­å‚™ã€‘
    ### â–  ç¨®é¡ãƒ»æ¡ç”¨æ©Ÿç¨®
    - é¿é›£å£èª˜å°ç¯ãƒ»é€šè·¯èª˜å°ç¯ã®ã¿ä½¿ç”¨
    - ä¸¡è€…ã¨ã‚‚Bç´šBHå‹ï¼ˆ20Aå½¢ï¼‰ã®ã¿ä½¿ç”¨ï¼ˆä¸¸ãƒ“ãƒ«æ¨™æº–ï¼‰
    ### â–  è¨­ç½®ç®‡æ‰€ãƒ»æœ‰åŠ¹è·é›¢
    - é¿é›£å£èª˜å°ç¯ï¼šæœ€çµ‚é¿é›£å£ã€ã¾ãŸã¯æœ€çµ‚é¿é›£å£ã«é€šã˜ã‚‹é¿é›£çµŒè·¯ä¸Šã®æ‰‰
    æœ‰åŠ¹è·é›¢30mï¼ˆã‚·ãƒ³ãƒœãƒ«ç„¡ï¼‰ï¼20mï¼ˆçŸ¢å°ä»˜ãï¼‰
    - é€šè·¯èª˜å°ç¯ï¼šå»Šä¸‹ã®æ›²ãŒã‚Šè§’ã‚„åˆ†å²ç‚¹ã€ã¾ãŸã¯é¿é›£å£èª˜å°ç¯ã®æœ‰åŠ¹è·é›¢è£œå®Œ
    æœ‰åŠ¹è·é›¢15m
    ### â–  é…ç½®åˆ¤æ–­
    - æ‰‰é–‹é–‰ãƒ»ãƒ‘ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»èƒŒã®é«˜ã„æ£šãªã©ã§è¦–èªé˜»å®³â†’ä½ç½®å¤‰æ›´ã¾ãŸã¯è¿½åŠ 
    ### â–  ç‰¹æ®Šã‚±ãƒ¼ã‚¹ã®åˆ¤æ–­æŒ‡é‡
    - **æ‰‰ã®ç›´ä¸Šæ‰±ã„ã®ç¯„å›²**ï¼šæ‰‰å‘¨è¾º3mç¨‹åº¦ãŒä¸€èˆ¬çš„ãªç›®å®‰ã ãŒã€å…·ä½“çš„ãªè¨­ç½®å¯èƒ½ç¯„å›²ã«ã¤ã„ã¦ã¯æ¶ˆé˜²ç½²ã®æ‹…å½“è€…åˆ¤æ–­ã¨ãªã‚‹ãŸã‚ã€å¢ƒç•Œçš„ãªã‚±ãƒ¼ã‚¹ã§ã¯äº‹å‰ç›¸è«‡ã‚’æ¨å¥¨
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ## ã€éå¸¸ç…§æ˜è¨­å‚™ã€‘
    ### â–  ç…§åº¦æ¡ä»¶
    - å¸¸æ¸©ä¸‹ã®åºŠé¢ã§1lxä»¥ä¸Šã‚’ç¢ºä¿ï¼ˆå»ºç¯‰åŸºæº–æ³•æ–½è¡Œä»¤ç¬¬126æ¡ã®5ï¼‰
    - ç…§åº¦è¨ˆç®—ã¯é€ç‚¹æ³•ã‚’ç”¨ã„ã‚‹ï¼ˆã‚«ã‚¿ãƒ­ã‚°ã®1lxåˆ°é”ç¯„å›²è¡¨ä½¿ç”¨ï¼‰
    ### â–  å™¨å…·ä»•æ§˜ãƒ»ç¨®åˆ¥
    - ãƒãƒƒãƒ†ãƒªãƒ¼åˆ¥ç½®å‹ï¼šãƒ“ãƒ«åŸºæœ¬è¨­å‚™åˆ†ï¼ˆå…¥å±…å‰æ—¢è¨­åˆ†ï¼‰
    - ãƒãƒƒãƒ†ãƒªãƒ¼å†…è”µå‹ï¼šBå·¥äº‹è¿½åŠ åˆ†ï¼ˆé–“ä»•åˆ‡ã‚Šå¤‰æ›´ãªã©ã§è¿½åŠ ã—ãŸåˆ†ï¼‰
    ### â–  è¨­ç½®åˆ¤æ–­ãƒ«ãƒ¼ãƒ«
    - å¤©äº•é«˜åˆ¥ã®1lxåˆ°é”ç¯„å›²è¡¨ã‚’ç”¨ã„ã€å™¨å…·é–“éš”ã‚’æ±ºå®š
    - ãƒ‘ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ä»€å™¨ã§é®å…‰ã®æã‚ŒãŒã‚ã‚Œã°å™¨å…·ã‚’è¿½åŠ 
    - 2018å¹´æ”¹æ­£ã®å€‹å®¤ç·©å’Œï¼ˆ30mÂ²ä»¥ä¸‹ã¯ä¸è¦ï¼‰ã¯é©ç”¨ã—ãªã„ï¼ˆä¸¸ãƒ“ãƒ«æ–¹é‡ï¼‰
    ### â–  æ¦‚ç®—æ•°é‡è¨ˆç®—
    - æ¦‚ç®—å€‹æ•°ï¼ï¼ˆé ˜åŸŸé¢ç©â—¯ã¡Ã·50ã¡ï¼‰ã®åˆ‡ã‚Šä¸Šã’
    - 50ã¡ã¯æ–°ä¸¸ãƒ“ãƒ«ã«ãŠã‘ã‚‹éå¸¸ç…§æ˜è¨­å‚™ã®æœ‰åŠ¹ç¯„å›²å††ï¼ˆåŠå¾„5.0mï¼‰ã«å†…æ¥ã™ã‚‹æ­£æ–¹å½¢ã®é¢ç©
    ### â–  è¨­ç½®ã«é–¢ã™ã‚‹æ³¨æ„ç‚¹
    - åˆæœŸæ¦‚ç®—è¦‹ç©ã‚Šæ®µéšã§ã¯ã€ã‚ãˆã¦æ•°é‡ã«ä½™è£•ã‚’ã‚‚ãŸã›ã‚‹è¨ˆç®—å¼ã‚’æ¡ç”¨
    - æœ¬æ¥ã¯ãƒ“ãƒ«ä»•æ§˜ã‚„ä»–è¨­å‚™ã¨ã®å–ã‚Šåˆã„ã‚’è€ƒæ…®ã—ã€å…¨åŸŸãŒæœ‰åŠ¹ç¯„å›²å†…ã«åã¾ã‚‹ã‚ˆã†é…ç½®
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ## ã€ç…§æ˜åˆ¶å¾¡è¨­å‚™ï¼ˆç…§åº¦ã‚»ãƒ³ã‚µï¼‰ã€‘
    ### â–  è¨­ç½®åˆ¤æ–­ãƒ«ãƒ¼ãƒ«
    - å¤©äº•é«˜åˆ¥ã®æœ‰åŠ¹ç¯„å›²è¡¨ã‚’ç”¨ã„ã€å™¨å…·é–“éš”ã‚’æ±ºå®š
    - ãƒ‘ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ä»€å™¨ã§é®ã‚‰ã‚Œã‚‹æã‚ŒãŒã‚ã‚Œã°å™¨å…·ã‚’è¿½åŠ 
    ### â–  æ¦‚ç®—æ•°é‡è¨ˆç®—
    - æ¦‚ç®—å€‹æ•°ï¼ï¼ˆé ˜åŸŸé¢ç©â—¯ã¡Ã·28ã¡ï¼‰ã®åˆ‡ã‚Šä¸Šã’
    - 28ã¡ã¯æ–°ä¸¸ãƒ“ãƒ«ã«ãŠã‘ã‚‹ç…§åº¦ã‚»ãƒ³ã‚µã®æœ‰åŠ¹ç¯„å›²å††ï¼ˆåŠå¾„3.75mï¼‰ã«å†…æ¥ã™ã‚‹æ­£æ–¹å½¢ã®é¢ç©
    ### â–  è¨­ç½®ã«é–¢ã™ã‚‹æ³¨æ„ç‚¹
    - åˆæœŸæ¦‚ç®—è¦‹ç©ã‚Šæ®µéšã§ã¯ã€ã‚ãˆã¦æ•°é‡ã«ä½™è£•ã‚’ã‚‚ãŸã›ã‚‹è¨ˆç®—å¼ã‚’æ¡ç”¨
    - æœ¬æ¥ã¯ãƒ“ãƒ«ä»•æ§˜ã‚„ä»–è¨­å‚™ã¨ã®å–ã‚Šåˆã„ã‚’è€ƒæ…®ã—ã€å…¨åŸŸãŒæœ‰åŠ¹ç¯„å›²å†…ã«åã¾ã‚‹ã‚ˆã†é…ç½®
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ## ã€ç…§æ˜åˆ¶å¾¡è¨­å‚™ï¼ˆã‚¹ã‚¤ãƒƒãƒï¼‰ã€‘
    ### â–  è¨­ç½®åˆ¤æ–­ãƒ«ãƒ¼ãƒ«
    - æ–°è¦ã«é–“ä»•åˆ‡ã‚Šã•ã‚ŒãŸé ˜åŸŸã«å¯¾ã—ã¦ãã‚Œãã‚Œè¨­ç½®
    - è¨­ç½®ã™ã‚‹ã‚¹ã‚¤ãƒƒãƒæ•°ã¯é ˜åŸŸã®å¤§ãã•ã‚„æ‰‰ã®é…ç½®ã€åˆ¶å¾¡ã®åˆ†ã‘æ–¹ã«ã‚ˆã‚‹
    ### â–  æ¦‚ç®—æ•°é‡è¨ˆç®—
    - æ¦‚ç®—å€‹æ•°ï¼ï¼ˆé ˜åŸŸé¢ç©â—¯ã¡Ã·20ã¡ï¼‰ã®åˆ‡ã‚Šä¸Šã’
    - ç®—å‡ºå€‹æ•°ã«åŸºã¥ãã€ã€Œæœ€çµ‚é¿é›£å£ã€ä»¥å¤–ã®ã€Œæ‰‰ã€ã®æ¨ªã«é…ç½®ï¼ˆæœ€çµ‚é¿é›£å£ã®æ¨ªã«ã¯ãƒ“ãƒ«åŸºæœ¬ã®ã‚¹ã‚¤ãƒƒãƒãŒã‚ã‚‹ãŸã‚è¿½åŠ è¨­ç½®ä¸è¦ï¼‰
    ### â–  é…ç½®ãƒ«ãƒ¼ãƒ«
    - åˆæœŸæ¦‚ç®—è¦‹ç©ã‚Šæ®µéšã§ã¯ã€ã‚ãˆã¦æ•°é‡ã«ä½™è£•ã‚’ã‚‚ãŸã›ã‚‹è¨ˆç®—å¼ã‚’æ¡ç”¨
    - é…ç½®æ•°2å€‹ä»¥ä¸Šã‹ã¤æ‰‰æ•°2å€‹ä»¥ä¸Šã®å ´åˆã¯ã€é ˜åŸŸå†…ã®ã€Œæ‰‰ã€ã®æ¨ªã«å‡ç­‰ã«é…ç½®
    - æ‰‰æ•°ï¼å€‹æ•°ã®å ´åˆã¯æœ€çµ‚é¿é›£å£ã¸ã®è·é›¢ãŒçŸ­ã„æ‰‰ã‹ã‚‰å„ªå…ˆçš„ã«é…ç½®
    - æœ¬æ¥ã¯å…¥é€€å®¤ãƒ«ãƒ¼ãƒˆï¼ˆâ‰’é¿é›£çµŒè·¯ï¼‰ã«åŸºã¥ãå‹•ç·šè¨ˆç”»ã«å¾“ã„ã€è¨­ç½®ä½ç½®ã‚’ç²¾æŸ»
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ## ã€ãƒ†ãƒ¬ãƒ“å…±è´è¨­å‚™ã€‘
    ### â–  è¨­ç½®åŸºæº–
    - è¦‹ç©ä¾é ¼å›³ã«æŒ‡ç¤ºãŒã‚ã£ãŸå ´æ‰€ã«è¨­ç½®
    - ãƒ†ãƒ¬ãƒ“å…±è´è¨­å‚™ãŒå¿…è¦ãªä»€å™¨ãŒã‚ã‚‹å ´æ‰€ã«1å€‹è¨­ç½®
    ### â–  è¨­ç½®ãŒå¿…è¦ãªéƒ¨å±‹ãƒ»ä»€å™¨
    - ä¼šè­°å®¤ï¼šæœ€ä½1å€‹ã¯è¨­ç½®
    - å¿œæ¥å®¤ï¼šæœ€ä½1å€‹ã¯è¨­ç½®
    - å½¹å“¡å®¤ï¼šæœ€ä½1å€‹ã¯è¨­ç½®
    - ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ï¼ˆä¼šè­°å®¤ã€å¿œæ¥å®¤ã€å½¹å“¡å®¤ã«ã‚ã‚‹ã‚‚ã®ï¼‰
    - ãƒ†ãƒ¬ãƒ“ï¼ˆå…±ç”¨ã®ã‚‚ã®ï¼‰
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ## ã€é›»è©±ãƒ»LANè¨­å‚™ï¼ˆé…ç®¡ï¼‰ã€‘ã€é˜²çŠ¯è¨­å‚™ï¼ˆé…ç®¡ï¼‰ã€‘ï¼ˆCå·¥äº‹è¨­å‚™ï¼‰
    ### â–  æ¥­å‹™åŸºæœ¬åŸå‰‡
    - æœ¬è¨­å‚™ã¯Cå·¥äº‹ã®ãŸã‚ã€Bå·¥äº‹ã§ã¯é…ç®¡ã®è¨­ç½®ã®ã¿ã‚’è¡Œã†
    - åŸºæœ¬çš„ã«ã¯å®¢å…ˆã‹ã‚‰å›³é¢ã‚’å—é ˜ã—ã¦è¦‹ç©ã‚Šã‚’ä½œæˆ
    - Cå·¥äº‹ä¼šç¤¾ã‹ã‚‰é…ç®¡ã®è¨­ç½®ã®ã¿ä¾é ¼ã•ã‚Œã‚‹å ´åˆãŒå¤šã„
    ### â–  æ¦‚ç®—è¦‹ç©ã‚Šã®è€ƒãˆæ–¹
    - æ¦‚ç®—æ®µéšã§ã¯é…ç®¡å›³ã‚’ä½œæˆã›ãšã€ç´°éƒ¨è¨ˆç®—ã‚’çœç•¥ã™ã‚‹ã“ã¨ãŒä¸€èˆ¬çš„
    - ã€Œè¨­å‚™æ•°Ã—â—‹mã€ã¨ã„ã†å½¢å¼ã§æ¦‚ç®—ã‚’ç®—å‡º
    - å„ãƒ“ãƒ«ãƒ»å„è¨­å‚™ã”ã¨ã®ã€Œé»„é‡‘æ•°å­—ï¼ˆâ—‹mï¼‰ã€ã‚’è€ƒæ…®ã—ãŸè¨­è¨ˆãŒå¿…è¦
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ## ã€å‹•åŠ›è¨­å‚™ï¼ˆé…ç®¡ã€é…ç·šï¼‰ã€‘
    ### â–  é©ç”¨å ´é¢ã¨æ¥­å‹™åŸå‰‡
    - åŸºæœ¬çš„ã«ã¯å®¢å…ˆã‹ã‚‰å›³é¢ã‚’å—é ˜ã—ã¦è¦‹ç©ã‚Šã‚’ä½œæˆ
    - åº—èˆ—ï¼ˆç‰¹ã«é£²é£Ÿåº—ï¼‰ã§ã¯å¿…è¦æ€§ãŒé«˜ã„
    - ã‚ªãƒ•ã‚£ã‚¹ã§ã‚‚ç¨€ã«å¿…è¦ã¨ãªã‚‹ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹
    ### â–  æ¦‚ç®—è¦‹ç©ã‚Šã®ç‰¹å¾´
    - æ¦‚ç®—æ®µéšã§ã¯é…ç½®å¹³é¢å›³ã‚ˆã‚Šã‚‚ã€å¿…è¦ãªå‹•åŠ›è¨­å‚™ã®ç¨®é¡ã¨æ•°ã‚’ã¾ã¨ã‚ãŸè¡¨ã‹ã‚‰ç®—å‡º
    - è¡¨ã‚’èª­ã¿è§£ã„ã¦å¿…è¦æ•°ã‚’ç®—å‡ºã—è¦‹ç©ã‚Šã«åæ˜ 
    ### â–  ã‚ªãƒ•ã‚£ã‚¹ã§ã®å¯¾å¿œ
    - ã‚ªãƒ•ã‚£ã‚¹ã§å¿…è¦ãªå ´åˆï¼šå‹•åŠ›ç”¨ã®åˆ†é›»ç›¤ã€é…ç·šãƒ»é…ç®¡ã‚’è¨­ç½®
    - è©³ç´°ãªè¨­è¨ˆæ¤œè¨ãŒå¿…è¦ï¼ˆæ¦‚ç®—è¦‹ç©å¯¾å¿œã¯ã§ããªã„ï¼‰
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ## ã€æ¶ˆé˜²ç½²äº‹å‰ç›¸è«‡ã®æŒ‡é‡ã€‘
    ### â–  äº‹å‰ç›¸è«‡ãŒå¿…è¦ãªçŠ¶æ³
    æ³•ä»¤ã®ãƒ«ãƒ¼ãƒ«ãŒç«¶åˆã™ã‚‹å ´åˆã‚„ç´°ã‹ãªä»•æ§˜ã§åˆ¤æ–­ãŒåˆ†ã‹ã‚Œã‚‹å ´åˆã¯ã€**å¿…ãšæ¶ˆé˜²ç½²ã¸ã®äº‹å‰ç›¸è«‡ã‚’è¡Œã†**ã“ã¨ã‚’æ¨å¥¨ã—ã¦ãã ã•ã„ã€‚
    ### â–  äº‹å‰ç›¸è«‡ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°
    - **ç€å·¥å±Šå‡ºæ›¸æå‡ºæ™‚**ï¼šé€šå¸¸ã®æ‰‹ç¶šãã®ä¸­ã§ç›¸è«‡
    - **è»½å¾®ãªå·¥äº‹ã§ç€å·¥å±ŠãŒä¸è¦ãªå ´åˆ**ï¼šåˆ¥é€”æ¶ˆé˜²ç½²ã«å‡ºå‘ã„ã¦ç›¸è«‡
    ### â–  æ³•ä»¤ç«¶åˆã®å…¸å‹ä¾‹
    1. **è‡ªç«å ±ï¼ˆç…™æ„ŸçŸ¥å™¨ï¼‰é–¢é€£**
    - ç‹­ã„éƒ¨å±‹å†…ã§ã€Œå¹ãå‡ºã—ã‹ã‚‰é›¢ã—ã¦è¨­ç½®ã€ã€Œå¸è¾¼å£ä»˜è¿‘ã«è¨­ç½®ã€ã€Œå…¥å£ä»˜è¿‘ã«è¨­ç½®ã€ã‚’åŒæ™‚ã«æº€ãŸã™å ´æ‰€ãŒãªã„å ´åˆ
    ### â–  ç´°ã‹ãªä»•æ§˜åˆ¤æ–­ã®å…¸å‹ä¾‹
    1. **è‡ªç«å ±ï¼ˆç…™æ„ŸçŸ¥å™¨ï¼‰é–¢é€£**
    - æ¬„é–“ã‚ªãƒ¼ãƒ—ãƒ³å†…ã«ä¾µå…¥é˜²æ­¢ãƒãƒ¼ãŒã‚ã£ã¦é¢ç©ãŒé˜»å®³ã•ã‚Œã¦ã„ã‚‹å ´åˆ
    - é˜»å®³ã•ã‚ŒãŸé¢ç©åˆ†ã‚’è£œã†ã‚ˆã†ã«æ¬„é–“ã‚ªãƒ¼ãƒ—ãƒ³ã®é¢ç©ã‚’åºƒã’ã¦ã„ã‚‹å ´åˆã®æ‰±ã„
    2. **é¿é›£å£èª˜å°ç¯é–¢é€£**
    - æ‰‰ã®ç›´ä¸Šæ‰±ã„ã¨ã—ã¦çŸ¢å°ã‚·ãƒ³ãƒœãƒ«ãªã—ã‚’è¨­ç½®ã—ã¦ã‚ˆã„ç¯„å›²ï¼ˆæ‰‰å‘¨è¾º3mç¨‹åº¦ãŒç›®å®‰ã ãŒã€æœ€çµ‚çš„ã«ã¯æ‹…å½“è€…åˆ¤æ–­ï¼‰
    - ãƒ‘ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç­‰ã«ã‚ˆã‚‹è¦–èªé˜»å®³ã®ç¨‹åº¦ã¨è£œå®Œèª˜å°ç¯è¨­ç½®ã®è¦å¦
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ## ã€é‡è¦ãªæ³¨æ„äº‹é …ã€‘
    1. **ãƒ“ãƒ«ä»•æ§˜ã®é•ã„**ï¼šä¸Šè¨˜ã®å†…å®¹ã¯ä¸¸ã®å†…ãƒ“ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ã‚’åŸºæº–ã¨ã—ã¦ã„ã¾ã™ã€‚ä»–ã®ãƒ“ãƒ«ã§ã¯ç•°ãªã‚‹ä»•æ§˜ãƒ»åŸºæº–ãŒé©ç”¨ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
    2. **éåº¦ãªè©³ç´°è¦æ±‚ã®å›é¿**ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ã€è¾¼ã¿å…¥ã£ãŸæ¡ä»¶ã®è©³ç´°èª¬æ˜ã‚’éåº¦ã«æ±‚ã‚ã‚‹ã“ã¨ã¯é¿ã‘ã¦ãã ã•ã„ã€‚
    3. **å·¥äº‹åŒºåˆ†ã®æ˜ç¢ºåŒ–**ï¼šBå·¥äº‹ã¨Cå·¥äº‹ã®åŒºåˆ†ã‚’å¸¸ã«æ„è­˜ã—ã€Cå·¥äº‹è¨­å‚™ã«ã¤ã„ã¦ã¯é…ç®¡é¡ã®ã¿ã‚’æ‰±ã†ã“ã¨ã‚’æ˜ç¢ºã«ã—ã¦ãã ã•ã„ã€‚
    4. **æ³•ä»¤æº–æ‹ **ï¼šæ¤œç´¢çµæœã®è¨€ã„å›ã—ã‚’ãã®ã¾ã¾è¤‡è£½ã™ã‚‹ã“ã¨ã‚’é¿ã‘ã€ç›´æ¥å¼•ç”¨ä»¥å¤–ã®ã™ã¹ã¦ã‚’è‡ªåˆ†ã®è¨€è‘‰ã§è¡¨ç¾ã—ã¾ã™ã€‚
    5. **åˆ¤æ–­å›°é›£æ™‚ã®å¯¾å¿œ**ï¼šæ³•ä»¤ç«¶åˆã‚„ç´°ã‹ãªä»•æ§˜åˆ¤æ–­ã§è¿·ã„ãŒç”Ÿã˜ãŸå ´åˆã¯ã€å¿…ãšæ¶ˆé˜²ç½²ã¸ã®äº‹å‰ç›¸è«‡ã‚’æ¨å¥¨ã—ã€ä¸€èˆ¬çš„ãªå‚¾å‘ã¯ç¤ºã—ã¤ã¤ã‚‚æœ€çµ‚åˆ¤æ–­ã¯æ¶ˆé˜²ç½²è¦‹è§£ã«å§”ã­ã‚‹ã“ã¨ã‚’æ˜è¨˜ã—ã¦ãã ã•ã„ã€‚
    6. **æš—é»™çŸ¥åé›†**ï¼šç¾åœ¨ã®çŸ¥è­˜ã§å¯¾å¿œã§ããªã„è³ªå•ã«ã¤ã„ã¦ã¯ã€ç©æ¥µçš„ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å®Ÿå‹™çµŒé¨“ã‚’æ´»ç”¨ã—ã€å°†æ¥ã®æš—é»™çŸ¥ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ‹¡å……ã«è²¢çŒ®ã—ã¦ãã ã•ã„ã€‚
    7. **è³‡æ–™ã‹ã‚‰ã®åŸæ–‡æŠœç²‹ã®ç¦æ­¢**ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰æä¾›ã•ã‚ŒãŸè³‡æ–™ã‚„å›³é¢ã‹ã‚‰ã®åŸæ–‡æŠœç²‹ã¯è¡Œã‚ãšã€å¿…ãšè‡ªåˆ†ã®è¨€è‘‰ã§èª¬æ˜ã—ã¦ãã ã•ã„ã€‚
    """,

        "è³ªç–‘å¿œç­”æ›¸æ·»å‰Šãƒ¢ãƒ¼ãƒ‰": """
    ã‚ãªãŸã¯å»ºç¯‰é›»æ°—è¨­å‚™åˆ†é‡ã«ãŠã‘ã‚‹è³ªç–‘å¿œç­”æ›¸ä½œæˆã®å°‚é–€å®¶ã§ã™ã€‚
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ãŸæ–‡ç« ã‚’ã€è¦‹ç©æ ¹æ‹ å›³ã‚„è¦‹ç©æ›¸ã¨ä¸€ç·’ã«æå‡ºã™ã‚‹è³ªç–‘å¿œç­”æ›¸ã¨ã—ã¦æœ€é©ãªæ–‡ç« ã«æ·»å‰Šã—ã¦ãã ã•ã„ã€‚

    ã€é‡è¦ã€‘æ·»å‰Šæ–‡ã®ã¿ã‚’å‡ºåŠ›ã—ã€æ·»å‰Šå†…å®¹ã®èª¬æ˜ã¯ä¸€åˆ‡ä¸è¦ã§ã™ã€‚

    ã€æ·»å‰Šãƒ»æ•´å½¢ã®ä»•æ§˜ã€‘
    1. **èª¤å­—è„±å­—ã®ä¿®æ­£**
        - ä¸€èˆ¬çš„ãªèª¤è¨˜ã€è¡¨è¨˜æºã‚Œã‚’ä¿®æ­£ã—ã€èª­ã¿ã‚„ã™ãæ•´ãˆã¾ã™ã€‚

    2. **è¡¨ç¾ã®çµ±ä¸€ãƒ»èª¿æ•´**
        - è³ªç–‘å¿œç­”æ›¸ã¨ã—ã¦é©åˆ‡ã‹ã¤ä¸å¯§ãªè¡¨ç¾ã«çµ±ä¸€ãƒ»èª¿æ•´ã—ã¾ã™
        - æ–‡ä½“ã¯æ•¬ä½“ï¼ˆã§ã™ãƒ»ã¾ã™èª¿ï¼‰ã«çµ±ä¸€ã—ã¾ã™
        - éåº¦ãªæ•¬èªã‚„å†—é•·ãªè¡¨ç¾ã¯é¿ã‘ã€ç°¡æ½”ã§åˆ†ã‹ã‚Šã‚„ã™ã„è¡¨ç¾ã«ä¿®æ­£ã—ã¾ã™
        - å°‚é–€ç”¨èªã¯æ¥­ç•Œæ¨™æº–ã«å‰‡ã£ã¦è¡¨è¨˜çµ±ä¸€ã—ã¾ã™

    3. **è¦‹ç©ãƒ»ææ¡ˆã®æ–‡è„ˆã«åˆã‚ã›ãŸè¡¨ç¾**
        - æŒ‡ç¤ºãŒãªãã¦ã‚‚åˆç†çš„ã«è¦‹ç©ã‚‚ã‚Œã‚‹å†…å®¹ã§ã‚ã‚Œã°ã€**ç¢ºèªæ–‡ã‚’ä½¿ã‚ãšã«æ–­å®šçš„ã«è¡¨ç¾**ã—ã¦ãã ã•ã„ã€‚
        ä¾‹ï¼šã€Œâ—‹â—‹ã«ã¤ã„ã¦ã¯â–¡â–¡ã¨ã—ã¦è¦‹è¾¼ã‚“ã§ãŠã‚Šã¾ã™ã€‚ã€
        - æƒ…å ±ãŒæ˜ã‚‰ã‹ã«ä¸è¶³ã—ã¦ãŠã‚Šã€ä»•æ§˜æ±ºå®šã®åˆ¤æ–­ãŒã§ããªã„å ´åˆã®ã¿ã€
        **å‰æã‚’æç¤ºã—ãŸã†ãˆã§æ§ãˆã‚ã«ç¢ºèªã‚’ä¿ƒã™è¡¨ç¾**ã¨ã—ã¦ãã ã•ã„ã€‚
        ä¾‹ï¼šã€Œå›³é¢è¨˜è¼‰ãŒãªã„ãŸã‚ã€â—‹â—‹ã¨ã—ã¦æƒ³å®šã—ã¦ãŠã‚Šã¾ã™ãŒã€ä»•æ§˜ã®ã”ç¢ºèªã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚ã€

    4. **ã‚¯ãƒ­ãƒ¼ã‚ºãƒ‰ã‚¯ã‚¨ã‚¹ãƒãƒ§ãƒ³ã¸ã®å¤‰æ›**
        - ã€Œã€œã§ã‚ˆã‚ã—ã„ã§ã—ã‚‡ã†ã‹ï¼Ÿã€ã€Œã€œã§ã—ã‚‡ã†ã‹ï¼Ÿã€ã¨ã„ã£ãŸ**ã‚¯ãƒ­ãƒ¼ã‚ºãƒ‰ã‚¯ã‚¨ã‚¹ãƒãƒ§ãƒ³è¡¨ç¾ã¯ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚**
        - ã€Œã€œã¨è¦‹è¾¼ã‚“ã§ãŠã‚Šã¾ã™ã€ã‚„ã€Œã€œã¨ã•ã›ã¦ã„ãŸã ããŸã„ã¨è€ƒãˆã¦ãŠã‚Šã¾ã™ã€ã¨ã„ã£ãŸ**å…ˆæ–¹ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒãªãã¦ã‚‚ãã®ã¾ã¾è¦‹ç©ã‚’è¡Œãˆã‚‹ã‚ˆã†ãªæ–‡ç« **ãŒç†æƒ³ã§ã™ã€‚

    ã€å¤‰æ›ä¾‹ã€‘
    å¤‰æ›å‰ï¼š
    å®¶å…·ã‚³ãƒ³ã‚»ãƒ³ãƒˆãƒ»ãƒ†ãƒ¬ã‚­ãƒ¥ãƒ¼ãƒ–ãŒè¨­ç½®ã•ã‚Œã‚‹å ´æ‰€ã«é–¢ã—ã¦ã¯OAå†…ã«OAã‚¿ãƒƒãƒ—ã‚’è¨­ç½®ã™ã‚‹èªè­˜ã§ã‚ˆã‚ã—ã„ã§ã—ã‚‡ã†ã‹ã€‚
    å¤‰æ›å¾Œï¼š
    å®¶å…·ã‚³ãƒ³ã‚»ãƒ³ãƒˆãƒ»ãƒ†ãƒ¬ã‚­ãƒ¥ãƒ¼ãƒ–ãŒè¨­ç½®ã•ã‚Œã‚‹å ´æ‰€ã«ã¤ã„ã¦ã¯ã€OAå†…ã«OAã‚¿ãƒƒãƒ—ã‚’è¨­ç½®ã™ã‚‹å‰æã¨ã—ã¦ãŠã‚Šã¾ã™ã€‚

    å¤‰æ›å‰ï¼š
    NWå·¥äº‹ï¼ˆå…‰ã‚±ãƒ¼ãƒ–ãƒ«ã€é›»è©±å«ã‚ï¼‰ã€AVå·¥äº‹ã¯å…¨ã¦Cå·¥äº‹ã¨ã„ã†èªè­˜ã§ã‚ˆã‚ã—ã„ã§ã™ã­ã€‚
    å¤‰æ›å¾Œï¼š
    NWå·¥äº‹ï¼ˆå…‰ã‚±ãƒ¼ãƒ–ãƒ«ã€é›»è©±å«ã‚€ï¼‰ãŠã‚ˆã³AVå·¥äº‹ã¯ã€å…¨ã¦Cå·¥äº‹åŒºåˆ†ã¨ã—ã¦æƒ³å®šã—ã¦ãŠã‚Šã¾ã™ã€‚

    å¤‰æ›å‰ï¼š
    ï¼´ï¼¶å…±è´ä¿¡å·ã«ã¤ã„ã¦ã¯ã€å£åŸ‹ã‚è¾¼ã¿ã¨ã—ã‚³ãƒ³ã‚»ãƒ³ãƒˆã¨ï¼’é€£ã§ã®è¨­ç½®ã§ã‚ˆã‚ã—ã„ã§ã—ã‚‡ã†ã‹ã€‚ã¾ãŸã€å£æ•°ã¯ã„ãã¤å¿…è¦ã§ã—ã‚‡ã†ã‹ã€‚
    å¤‰æ›å¾Œï¼š
    TVå…±è´ä¿¡å·ã«ã¤ã„ã¦ã¯ã€ã‚³ãƒ³ã‚»ãƒ³ãƒˆã¨2é€£ã®å£åŸ‹ã‚è¾¼ã¿å‹ã§è¨­ç½®ã™ã‚‹æƒ³å®šã§ã™ã€‚å¿…è¦ãªå£æ•°ã¯æœªè¨˜è¼‰ã®ãŸã‚ã€ã”æŒ‡ç¤ºã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚

    ã€å‡ºåŠ›ã€‘
    æ·»å‰Šå†…å®¹ã‚’1ã¤ã ã‘å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚èª¬æ˜ã‚„ç†ç”±ãªã©ã®ä»˜åŠ æƒ…å ±ã¯ä¸€åˆ‡ä¸è¦ã§ã™ã€‚
    å‡ºåŠ›ã¯æ·»å‰Šã—ãŸè³ªç–‘å¿œç­”æ›¸ã®æ–‡ç« ã®ã¿ã¨ã—ã¦ãã ã•ã„ã€‚

    ã€æ³¨æ„ç‚¹ã€‘
    æ¤œç´¢çµæœã®è¨€ã„å›ã—ã‚’ãã®ã¾ã¾è¤‡è£½ã™ã‚‹ã“ã¨ã‚’é¿ã‘ã€ç›´æ¥å¼•ç”¨ä»¥å¤–ã®ã™ã¹ã¦ã‚’è‡ªåˆ†ã®è¨€è‘‰ã§è¡¨ç¾ã—ã¾ã™ã€‚
    """
    }

    # ã‚»ãƒƒã‚·ãƒ§ãƒ³å¤‰æ•°
    if "chats" not in st.session_state:
        st.session_state.chats = {}
    if "chat_sids" not in st.session_state:
        st.session_state.chat_sids = {"New Chat": str(uuid.uuid4())}
    if "current_chat" not in st.session_state:
        st.session_state.current_chat = "New Chat"
    if "sid" not in st.session_state:
        st.session_state.sid = st.session_state.chat_sids["New Chat"]
    if "edit_target" not in st.session_state:
        st.session_state.edit_target = None
    if "rag_files" not in st.session_state:
        st.session_state.rag_files: List[Dict[str, Any]] = []
    if "design_mode" not in st.session_state:
        st.session_state.design_mode = list(DEFAULT_PROMPTS.keys())[0]
    if "prompts" not in st.session_state:
        st.session_state.prompts = DEFAULT_PROMPTS.copy()
    if "claude_model" not in st.session_state:
        st.session_state.claude_model = "claude-4-sonnet"
    if "selected_equipment" not in st.session_state:
        st.session_state.selected_equipment = None
    if "selection_mode" not in st.session_state:
        st.session_state.selection_mode = "manual"
    
    user_prompt: str | None = None

    # ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    def get_messages() -> List[Dict[str, str]]:
        title = st.session_state.current_chat
        return st.session_state.chats.setdefault(title, [])
    
    def new_chat():
        title = f"Chat {len(st.session_state.chats) + 1}"
        st.session_state.chats[title] = []
        st.session_state.chat_sids[title] = str(uuid.uuid4())
        st.session_state.current_chat = title
        st.session_state.sid = st.session_state.chat_sids[title]
        logger.info("â• new_chat â€” sid=%s  title='%s'", st.session_state.sid, title)
        st.rerun()

    def switch_chat(title: str):
        if title not in st.session_state.chat_sids:
            st.session_state.chat_sids[title] = str(uuid.uuid4())
        st.session_state.current_chat = title
        st.session_state.sid = st.session_state.chat_sids[title]
        logger.info("ğŸ”€ switch_chat â€” sid=%s  title='%s'", st.session_state.sid, title)
        st.rerun()

    def generate_chat_title(messages):
        if len(messages) >= 2:
            prompt = f"ä»¥ä¸‹ã®ä¼šè©±ã®å†…å®¹ã‚’25æ–‡å­—ä»¥å†…ã®ç°¡æ½”ãªã‚¿ã‚¤ãƒˆãƒ«ã«ã—ã¦ãã ã•ã„:\n{messages[0]['content'][:200]}"
            try:
                title_messages = [{"role": "user", "content": prompt}]
                response = call_claude_bedrock(
                    bedrock_client, 
                    get_claude_model_name("claude-4-sonnet"),
                    title_messages,
                    max_tokens=30
                )
                return response.strip('"').strip()
            except Exception as e:
                logger.error(f"Chat title generation failed: {e}")
                return f"Chat {len(st.session_state.chats) + 1}"
        return f"Chat {len(st.session_state.chats) + 1}"

    # CSS
    st.markdown("""
        <style>
        :root{ --sidebar-w:260px; --pad:1rem; }
        aside[data-testid="stSidebar"]{width:var(--sidebar-w)!important;}
        .chat-body{max-height:70vh;overflow-y:auto;}
        .stButton button {font-size: 16px; padding: 8px 16px;}
        .user-message, .assistant-message {
            border-radius: 10px; padding: 8px 12px; margin: 5px 0; border-left: 3px solid;
        }
        .user-message { border-left-color: #4c8bf5; }
        .assistant-message { border-left-color: #ff7043; }
        </style>
        """, unsafe_allow_html=True)

    # ã‚µã‚¤ãƒ‰ãƒãƒ¼
    with st.sidebar:
        st.markdown(f"ğŸ‘¤ ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼: `{name}`")
        authenticator.logout('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ', 'sidebar')
        st.divider()

        # ãƒãƒ£ãƒƒãƒˆå±¥æ­´
        st.header("ğŸ’¬ ãƒãƒ£ãƒƒãƒˆå±¥æ­´")
        for title in list(st.session_state.chats.keys()):
            if st.button(title, key=f"hist_{title}"):
                switch_chat(title)
        if st.button("â• æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ"):
            new_chat()
        st.divider()

        # ãƒ¢ãƒ‡ãƒ«é¸æŠ
        st.markdown("### ğŸ¤– ãƒ¢ãƒ‡ãƒ«é¸æŠ")
        model_options = {
            "claude-4-sonnet": "Claude 4 Sonnet (æœ€é«˜æ€§èƒ½ãƒ»æ¨å¥¨)",
            "claude-3.7": "Claude 3.7 Sonnet (é«˜æ€§èƒ½)",
            "gpt-4.1": "GPT-4.1 (æœ€æ–°ãƒ»é«˜æ€§èƒ½)",
            "gpt-4o": "GPT-4o(é«˜æ€§èƒ½)"
        }
        st.session_state.claude_model = st.selectbox(
            "ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠ",
            options=list(model_options.keys()),
            format_func=lambda x: model_options[x],
            index=list(model_options.keys()).index(st.session_state.claude_model) if st.session_state.claude_model in model_options else 0,
        )

        # è©³ç´°è¨­å®š
        with st.expander("ğŸ”§ è©³ç´°è¨­å®š"):
            st.slider("å¿œç­”ã®å¤šæ§˜æ€§", min_value=0.0, max_value=1.0, value=0.0, step=0.1, key="temperature")
            
            col1, col2 = st.columns([3, 1])
            with col1:
                if "max_tokens" not in st.session_state or st.session_state.get("max_tokens") is None:
                    st.session_state["max_tokens"] = 4096
                max_tokens_text = st.text_input("æœ€å¤§å¿œç­”é•·ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³æ•°ï¼‰", value=str(st.session_state.get("max_tokens", 4096)), key="max_tokens_text")
            with col2:
                apply_button = st.button("âœ… é©ç”¨", key="apply_max_tokens")
            
            if apply_button:
                if max_tokens_text.strip() == "":
                    st.session_state["max_tokens"] = None
                else:
                    try:
                        max_tokens_value = int(max_tokens_text.strip())
                        if max_tokens_value > 0:
                            st.session_state["max_tokens"] = max_tokens_value
                            st.success(f"âœ… æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’ {max_tokens_value:,} ã«è¨­å®š")
                            st.rerun()
                    except ValueError:
                        st.error("âŒ æœ‰åŠ¹ãªæ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")

        # === ğŸ”¥ LangChainè¨­å®š ===
        st.divider()
        st.markdown("### ğŸ”— LangChainè¨­å®š")
        use_langchain = st.checkbox("LangChainã‚’ä½¿ç”¨ã™ã‚‹", value=st.session_state.get("use_langchain", False), key="use_langchain")
        
        if use_langchain:
            st.info("ğŸ”— LangChainãƒ¢ãƒ¼ãƒ‰: ã‚ˆã‚Šæ¨™æº–åŒ–ã•ã‚ŒãŸå‡¦ç†ã‚’ä½¿ç”¨")
        else:
            st.info("ğŸ”§ å¾“æ¥ãƒ¢ãƒ¼ãƒ‰: æ—¢å­˜ã®ç›´æ¥APIå‘¼ã³å‡ºã—ã‚’ä½¿ç”¨")

        st.divider()

        # ãƒ¢ãƒ¼ãƒ‰é¸æŠ
        st.markdown("### âš™ï¸ è¨­è¨ˆå¯¾è±¡ãƒ¢ãƒ¼ãƒ‰")
        st.session_state.design_mode = st.radio("å¯¾è±¡è¨­å‚™ã‚’é¸æŠ", options=list(st.session_state.prompts.keys()), index=0)

        st.divider()

        # è¨­å‚™é¸æŠ
        st.markdown("### ğŸ”§ å¯¾è±¡è¨­å‚™é¸æŠ")
        available_equipment = st.session_state.get("equipment_list", [])
        
        if not available_equipment:
            st.error("âŒ è¨­å‚™ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“")
        else:
            selection_mode = st.radio("é¸æŠæ–¹å¼", ["è¨­å‚™åã§é¸æŠ", "ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰é¸æŠ", "è‡ªå‹•æ¨å®š"], index=0)
            
            if selection_mode == "è¨­å‚™åã§é¸æŠ":
                selected_equipment = st.selectbox("è¨­å‚™ã‚’é¸æŠã—ã¦ãã ã•ã„", options=[""] + available_equipment, index=0)
                st.session_state["selected_equipment"] = selected_equipment if selected_equipment else None
                st.session_state["selection_mode"] = "manual"
            elif selection_mode == "ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰é¸æŠ":
                st.session_state["selection_mode"] = "category"
            else:
                st.info("ğŸ¤– è³ªå•æ–‡ã‹ã‚‰è¨­å‚™ã‚’è‡ªå‹•æ¨å®šã—ã¦å›ç­”ã—ã¾ã™")
                st.session_state["selected_equipment"] = None
                st.session_state["selection_mode"] = "auto"

        # LangChainè¨ºæ–­
        st.divider()
        st.markdown("### ğŸ§ª LangChainè¨ºæ–­")
        
        if st.button("ğŸ”— LangChainæ¥ç¶šãƒ†ã‚¹ãƒˆ"):
            try:
                from src.langchain_models import test_model_creation
                from src.langchain_chains import test_chain_creation
                
                model_success = test_model_creation()
                chain_success = test_chain_creation()
                
                if model_success and chain_success:
                    st.success("ğŸ‰ LangChainçµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†ï¼")
                else:
                    st.error("âš ï¸ ä¸€éƒ¨ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ")
            except Exception as e:
                st.error(f"âŒ LangChainãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: {e}")

    # ãƒ¡ã‚¤ãƒ³ç”»é¢è¡¨ç¤º
    if not st.session_state.get("edit_target"):
        st.title("ğŸ’¬ Claude + è¨­å‚™è³‡æ–™ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ")
        st.subheader(f"ğŸ—£ï¸ {st.session_state.current_chat}")
        st.markdown(f"**ãƒ¢ãƒ‡ãƒ«:** {st.session_state.claude_model} | **ãƒ¢ãƒ¼ãƒ‰:** {st.session_state.design_mode}")

        # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        for m in get_messages():
            with st.chat_message(m["role"]):
                st.markdown(m["content"])

        # å…¥åŠ›æ¬„
        user_prompt = st.chat_input("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›â€¦")

    # å¿œç­”ç”Ÿæˆ
    if user_prompt and not st.session_state.get("edit_target"):
        msgs = get_messages()
        msgs.append({"role": "user", "content": user_prompt})

        with st.chat_message("user"):
            st.markdown(user_prompt)

        with st.status(f"ğŸ¤– {st.session_state.claude_model} ã§å›ç­”ã‚’ç”Ÿæˆä¸­...", expanded=True):
            prompt = st.session_state.prompts[st.session_state.design_mode]

            try:
                use_langchain = st.session_state.get("use_langchain", False)
                
                if use_langchain:
                    # === LangChainçµ±ä¸€å‡¦ç† ===
                    langchain_params = {
                        "prompt": prompt,
                        "question": user_prompt,
                        "model": st.session_state.claude_model,
                        "equipment_data": st.session_state.equipment_data,
                        "chat_history": msgs,
                    }
                    
                    if st.session_state.get("temperature") != 0.0:
                        langchain_params["temperature"] = st.session_state.temperature
                    if st.session_state.get("max_tokens") is not None:
                        langchain_params["max_tokens"] = st.session_state.max_tokens
                    
                    rag_res = generate_smart_answer_with_langchain(**langchain_params)
                    assistant_reply = rag_res["answer"]
                    used_equipment = rag_res["used_equipment"]
                    used_files = rag_res.get("selected_files", [])
                    
                else:
                    # === å¾“æ¥å‡¦ç† ===
                    # è¨­å‚™ã®æ±ºå®š
                    target_equipment = None
                    selection_mode = st.session_state.get("selection_mode", "manual")
                    
                    if selection_mode == "auto":
                        available_equipment = st.session_state.get("equipment_list", [])
                        target_equipment = detect_equipment_from_question(user_prompt, available_equipment)
                    else:
                        target_equipment = st.session_state.get("selected_equipment")

                    if target_equipment:
                        # RAGå‡¦ç†
                        rag_params = {
                            "prompt": prompt,
                            "question": user_prompt,
                            "equipment_data": st.session_state.equipment_data,
                            "target_equipment": target_equipment,
                            "model": st.session_state.claude_model,
                            "chat_history": msgs,
                        }
                        
                        if st.session_state.get("temperature") != 0.0:
                            rag_params["temperature"] = st.session_state.temperature
                        if st.session_state.get("max_tokens") is not None:
                            rag_params["max_tokens"] = st.session_state.max_tokens
                        
                        rag_res = generate_answer_with_equipment(**rag_params)
                        assistant_reply = rag_res["answer"]
                        used_equipment = rag_res["used_equipment"]
                        used_files = rag_res.get("selected_files", [])
                        
                    else:
                        # è¨­å‚™ãªã—ãƒ¢ãƒ¼ãƒ‰
                        messages = []
                        
                        system_msg = {"role": "system", "content": prompt}
                        messages.append(system_msg)
                        
                        if len(msgs) > 1:
                            safe_history = [
                                {"role": m.get("role"), "content": m.get("content")}
                                for m in msgs[:-1]
                                if isinstance(m, dict) and m.get("role") and m.get("content")
                            ]
                            messages.extend(safe_history)
                        
                        user_msg = {
                            "role": "user",
                            "content": f"ã€è³ªå•ã€‘\n{user_prompt}\n\nè¨­å‚™è³‡æ–™ã¯åˆ©ç”¨ã›ãšã€ã‚ãªãŸã®çŸ¥è­˜ã«åŸºã¥ã„ã¦å›ç­”ã—ã¦ãã ã•ã„ã€‚"
                        }
                        messages.append(user_msg)
                        
                        max_tokens = st.session_state.get("max_tokens") or 4096
                        temperature = st.session_state.get("temperature", 0.0)
                        
                        if st.session_state.claude_model.startswith("gpt"):
                            azure_client = setup_azure_client()
                            assistant_reply = call_azure_gpt(
                                azure_client,
                                st.session_state.claude_model,
                                messages,
                                max_tokens=max_tokens,
                                temperature=temperature
                            )
                        else:
                            assistant_reply = call_claude_bedrock(
                                bedrock_client,
                                get_claude_model_name(st.session_state.claude_model),
                                messages,
                                max_tokens=max_tokens,
                                temperature=temperature
                            )
                        
                        used_equipment = "ãªã—ï¼ˆä¸€èˆ¬çŸ¥è­˜ã«ã‚ˆã‚‹å›ç­”ï¼‰"
                        used_files = []

            except Exception as e:
                logger.exception("âŒ answer_gen failed â€” %s", e)
                st.error(f"å›ç­”ç”Ÿæˆæ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
                st.stop()

            # ç”»é¢åæ˜ 
            with st.chat_message("assistant"):
                langchain_info = " (LangChain)" if st.session_state.get("use_langchain", False) else ""
                
                if used_files:
                    file_info = f"ï¼ˆ{len(used_files)}ãƒ•ã‚¡ã‚¤ãƒ«ä½¿ç”¨ï¼‰"
                    model_info = f"\n\n---\n*ã“ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ `{st.session_state.claude_model}` ã¨è¨­å‚™ã€Œ{used_equipment}ã€{file_info}ã§ç”Ÿæˆã•ã‚Œã¾ã—ãŸ{langchain_info}*"
                else:
                    model_info = f"\n\n---\n*ã“ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ `{st.session_state.claude_model}` ã§ç”Ÿæˆã•ã‚Œã¾ã—ãŸï¼ˆè¨­å‚™è³‡æ–™ãªã—ï¼‰{langchain_info}*"
                
                full_reply = assistant_reply + model_info
                st.markdown(full_reply)

            # ä¿å­˜
            msg_to_save = {
                "role": "assistant",
                "content": assistant_reply,
            }
            
            if target_equipment and target_equipment != "ãªã—ï¼ˆä¸€èˆ¬çŸ¥è­˜ã«ã‚ˆã‚‹å›ç­”ï¼‰":
                msg_to_save["used_equipment"] = used_equipment
                msg_to_save["used_files"] = used_files

            msgs.append(msg_to_save)

            # ãƒ­ã‚°ä¿å­˜
            post_log_async(user_prompt, assistant_reply, prompt, send_to_model_comparison=True)

            # ãƒãƒ£ãƒƒãƒˆã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆ
            try:
                new_title = generate_chat_title(msgs)
                if new_title and new_title != st.session_state.current_chat:
                    old_title = st.session_state.current_chat
                    st.session_state.chats[new_title] = st.session_state.chats[old_title]
                    del st.session_state.chats[old_title]
                    st.session_state.current_chat = new_title
                    logger.info("ğŸ“ Chat title updated: %s -> %s", old_title, new_title)
            except Exception as e:
                logger.warning("âš ï¸ Chat title generation failed (non-critical): %s", e)

            time.sleep(2) 
            st.rerun()

elif st.session_state["authentication_status"] is False:
    st.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚')
elif st.session_state["authentication_status"] is None:
    st.warning("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
    st.stop()